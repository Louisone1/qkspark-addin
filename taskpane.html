<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>æ™ºç¼–ç¼–è¾‘åŠ©æ‰‹</title>
  <script src="https://appsforoffice.microsoft.com/lib/1/hosted/office.js"></script>
  <style>
    :root {
      --primary: #0078d4;
      --primary-hover: #106ebe;
      --error: #d13438;
      --error-bg: #fde7e9;
      --warning: #ca5010;
      --warning-bg: #fff4ce;
      --info: #0078d4;
      --info-bg: #deecf9;
      --success: #107c10;
      --success-bg: #dff6dd;
      --bg: #f5f5f5;
      --card: #fff;
      --border: #edebe9;
      --text: #323130;
      --muted: #605e5c;
      --radius: 6px;
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif; background: var(--bg); color: var(--text); font-size: 13px; line-height: 1.5; }
    #app { padding: 12px; width: 100%; }
    .header { display: flex; align-items: center; gap: 8px; margin-bottom: 12px; }
    .header h1 { font-size: 16px; color: var(--primary); }
    .header .ver { font-size: 11px; color: var(--muted); }
    .status-bar { padding: 6px 10px; border-radius: var(--radius); margin-bottom: 10px; font-size: 12px; text-align: center; display: none; }
    .status-bar.show { display: block; }
    .status-bar.ok { background: var(--success-bg); color: var(--success); }
    .status-bar.err { background: var(--error-bg); color: var(--error); }
    .status-bar.loading { background: var(--info-bg); color: var(--info); }
    .card { background: var(--card); border: 1px solid var(--border); border-radius: var(--radius); padding: 12px; margin-bottom: 10px; }
    .card h2 { font-size: 14px; margin-bottom: 6px; }
    .card .hint { font-size: 11px; color: var(--muted); margin-bottom: 8px; }
    .btn { display: block; width: 100%; padding: 9px; border: none; border-radius: var(--radius); font-size: 13px; cursor: pointer; transition: background 0.15s; }
    .btn-primary { background: var(--primary); color: #fff; }
    .btn-primary:hover { background: var(--primary-hover); }
    .btn-primary:disabled { background: #c8c6c4; cursor: not-allowed; }
    .btn-sm { display: inline-block; width: auto; padding: 4px 10px; font-size: 12px; border-radius: 4px; }
    .btn-ghost { background: transparent; color: var(--primary); border: 1px solid var(--primary); }
    .btn-ghost:hover { background: var(--info-bg); }
    .btn-success { background: var(--success); color: #fff; }
    .btn-success:hover { background: #0b6a0b; }
    .btn-danger { background: transparent; color: var(--muted); border: 1px solid var(--border); }
    .btn-danger:hover { background: #f3f2f1; }
    .progress-wrap { margin: 8px 0; display: none; }
    .progress-wrap.show { display: block; }
    .progress-bar { height: 4px; background: #edebe9; border-radius: 2px; overflow: hidden; }
    .progress-fill { height: 100%; background: var(--primary); width: 0%; transition: width 0.3s; }
    .progress-text { font-size: 11px; color: var(--muted); margin-top: 4px; text-align: center; }
    .stats { display: flex; gap: 8px; margin: 8px 0; flex-wrap: wrap; }
    .stat-badge { display: inline-flex; align-items: center; gap: 4px; padding: 3px 8px; border-radius: 999px; font-size: 11px; font-weight: 600; cursor: pointer; }
    .stat-badge.active { box-shadow: 0 0 0 2px var(--primary); }
    .stat-error { background: var(--error-bg); color: var(--error); }
    .stat-warning { background: var(--warning-bg); color: var(--warning); }
    .stat-info { background: var(--info-bg); color: var(--info); }
    .issue-list { max-height: 55vh; overflow-y: auto; }
    .issue-item { padding: 10px; border-bottom: 1px solid var(--border); transition: background 0.1s; }
    .issue-item:last-child { border-bottom: none; }
    .issue-item.resolved { opacity: 0.5; }
    .issue-item.resolved .issue-content { text-decoration: line-through; }
    .issue-cat { font-size: 10px; padding: 1px 6px; border-radius: 3px; color: #fff; display: inline-block; margin-bottom: 4px; }
    .cat-spelling { background: #d13438; }
    .cat-grammar { background: #ca5010; }
    .cat-punctuation { background: #8764b8; }
    .cat-terminology { background: #0078d4; }
    .cat-consistency { background: #00b7c3; }
    .cat-expression { background: #498205; }
    .issue-sev { display: inline-block; width: 8px; height: 8px; border-radius: 50%; margin-right: 4px; vertical-align: middle; }
    .sev-error { background: var(--error); }
    .sev-warning { background: var(--warning); }
    .sev-info { background: var(--info); }
    .issue-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 4px; }
    .issue-para { font-size: 10px; color: var(--muted); }
    .issue-content { margin-bottom: 6px; }
    .issue-original { color: var(--error); text-decoration: line-through; }
    .issue-arrow { color: var(--muted); margin: 0 4px; }
    .issue-suggestion { color: var(--success); font-weight: 600; }
    .issue-reason { font-size: 11px; color: var(--muted); margin-bottom: 8px; }
    .issue-actions { display: flex; gap: 6px; }
    .issue-status { font-size: 11px; padding: 2px 8px; border-radius: 3px; display: inline-block; margin-top: 4px; }
    .status-accepted { background: var(--success-bg); color: var(--success); }
    .status-ignored { background: #f3f2f1; color: var(--muted); }
    .batch-actions { display: flex; gap: 6px; margin: 8px 0; flex-wrap: wrap; }
    .summary-bar { display: flex; gap: 12px; font-size: 12px; color: var(--muted); margin: 8px 0; padding: 6px 10px; background: #f3f2f1; border-radius: var(--radius); }
    .summary-bar span { display: inline-flex; align-items: center; gap: 3px; }
    .settings-section { margin-top: 8px; }
    .settings-section label { font-size: 12px; color: var(--muted); display: block; margin-bottom: 4px; }
    .settings-section input { width: 100%; padding: 6px 8px; border: 1px solid var(--border); border-radius: 4px; font-size: 12px; }
  </style>
</head>
<body>
<div id="app">
  <div class="header">
    <span style="font-size:20px">ğŸ“</span>
    <h1>æ™ºç¼–ç¼–è¾‘åŠ©æ‰‹</h1>
    <span class="ver">v0.3.0</span>
  </div>

  <div id="statusBar" class="status-bar"></div>

  <div class="card">
    <h2>ğŸ“‹ å…¨æ–‡ç¼–æ ¡</h2>
    <p class="hint">è¯»å– Word å…¨æ–‡ï¼ŒAI é€æ®µæ£€æŸ¥è¯­è¨€é—®é¢˜</p>
    <button id="btnProofread" class="btn btn-primary" onclick="startProofread()">å¼€å§‹ç¼–æ ¡</button>
    <div id="progressWrap" class="progress-wrap">
      <div class="progress-bar"><div id="progressFill" class="progress-fill"></div></div>
      <div id="progressText" class="progress-text"></div>
    </div>
  </div>

  <div class="card">
    <h2>ğŸ“š å‚è€ƒæ–‡çŒ®æ ¸æŸ¥</h2>
    <p class="hint">æå–æ–‡æœ«å‚è€ƒæ–‡çŒ®ï¼Œæ£€æŸ¥æ ¼å¼è§„èŒƒä¸ DOI æœ‰æ•ˆæ€§</p>
    <label style="font-size:11px; display:flex; align-items:center; gap:6px; margin-bottom:8px">
      <input type="checkbox" id="chkVerifyDoi" checked> è”ç½‘éªŒè¯ DOIï¼ˆè¾ƒæ…¢ï¼‰
    </label>
    <button class="btn btn-primary" onclick="startRefCheck()">å¼€å§‹æ–‡çŒ®æ ¸æŸ¥</button>
    <div id="refProgressText" class="progress-text" style="margin-top:6px"></div>
  </div>

  <div id="refResultCard" class="card" style="display:none">
    <h2>ğŸ“š æ–‡çŒ®æ ¸æŸ¥ç»“æœ</h2>
    <div id="refSummaryBar" class="summary-bar"></div>
    <div id="refIssueList" class="issue-list" style="margin-top:8px"></div>
  </div>

  <div id="resultCard" class="card" style="display:none">
    <h2>ğŸ“Š ç¼–æ ¡æŠ¥å‘Š</h2>

    <div class="stats" id="statsBar"></div>

    <div id="summaryBar" class="summary-bar" style="display:none"></div>

    <div id="batchActions" class="batch-actions" style="display:none">
      <button class="btn btn-sm btn-success" onclick="batchAcceptAll()">âœ… å…¨éƒ¨é‡‡çº³</button>
      <button class="btn btn-sm btn-danger" onclick="batchIgnoreAll()">âŒ å…¨éƒ¨å¿½ç•¥</button>
    </div>

    <div id="issueList" class="issue-list"></div>

    <div style="display:flex; gap:8px; margin-top:10px">
      <button class="btn btn-sm btn-ghost" onclick="writeComments()">ğŸ’¬ å†™å…¥æ‰¹æ³¨</button>
      <button class="btn btn-sm btn-ghost" onclick="exportReport()">ğŸ“„ å¯¼å‡ºæŠ¥å‘Š</button>
      <button class="btn btn-sm btn-danger" onclick="clearResults()">ğŸ—‘ï¸ æ¸…é™¤æŠ¥å‘Š</button>
    </div>
  </div>

  <!-- çŸ¥è¯†åº“ç®¡ç† -->
  <div class="card" style="margin-top:10px">
    <h2 style="font-size:13px; margin:0 0 8px 0">ğŸ“š çŸ¥è¯†åº“</h2>
    <div id="kbStatus" style="font-size:11px; color:var(--muted); margin-bottom:8px">åŠ è½½ä¸­...</div>
    <div style="display:flex; gap:6px; align-items:center; flex-wrap:wrap">
      <input type="file" id="kbFile" accept=".txt,.md,.json" style="font-size:11px; flex:1; min-width:0">
      <button class="btn btn-sm btn-primary" onclick="uploadKnowledge()">ä¸Šä¼ </button>
    </div>
    <div id="kbSources" style="margin-top:8px; font-size:11px"></div>
  </div>

  <div class="card settings-section" style="display:none;">
    <h2>âš™ï¸ è®¾ç½®</h2>
    <label>åç«¯åœ°å€</label>
    <input id="apiUrl" type="text" value="" placeholder="ç•™ç©ºä½¿ç”¨å½“å‰æœåŠ¡å™¨"/>
  </div>
</div>

<script>
var allIssues = [];
var issueStates = {}; // idx -> 'pending' | 'accepted' | 'ignored'
var currentFilter = 'all';

Office.onReady(function(info) {
  if (info.host === Office.HostType.Word) {
    showStatus('âœ… Word å·²è¿æ¥', 'ok');
    setTimeout(function() { hideStatus(); }, 2000);
  }
});

function getApiBase() {
  var v = document.getElementById('apiUrl').value.trim();
  return v ? v.replace(/\/+$/, '') : '';
}

function showStatus(msg, type) {
  var el = document.getElementById('statusBar');
  el.textContent = msg;
  el.className = 'status-bar show ' + (type || '');
}
function hideStatus() {
  document.getElementById('statusBar').className = 'status-bar';
}

function startProofread() {
  var btn = document.getElementById('btnProofread');
  btn.disabled = true;
  btn.textContent = 'ç¼–æ ¡ä¸­...';
  showStatus('æ­£åœ¨è¯»å–æ–‡æ¡£...', 'loading');

  Word.run(function(ctx) {
    var paragraphs = ctx.document.body.paragraphs;
    paragraphs.load('text');
    return ctx.sync().then(function() {
      var items = [];
      for (var i = 0; i < paragraphs.items.length; i++) {
        var t = paragraphs.items[i].text.trim();
        if (t.length > 0) {
          items.push({ index: i, text: t });
        }
      }
      return callProofread(items);
    });
  }).catch(function(err) {
    showStatus('âŒ è¯»å–æ–‡æ¡£å¤±è´¥: ' + err.message, 'err');
    btn.disabled = false;
    btn.textContent = 'å¼€å§‹ç¼–æ ¡';
  });
}

function callProofread(paragraphs) {
  var btn = document.getElementById('btnProofread');
  var pw = document.getElementById('progressWrap');
  var pf = document.getElementById('progressFill');
  var pt = document.getElementById('progressText');
  pw.className = 'progress-wrap show';

  var batchSize = 10;
  var batches = [];
  for (var i = 0; i < paragraphs.length; i += batchSize) {
    batches.push(paragraphs.slice(i, i + batchSize));
  }

  allIssues = [];
  issueStates = {};
  var done = 0;

  function nextBatch(idx) {
    if (idx >= batches.length) {
      pf.style.width = '100%';
      pt.textContent = 'ç¼–æ ¡å®Œæˆ';
      btn.disabled = false;
      btn.textContent = 'å¼€å§‹ç¼–æ ¡';
      showStatus('âœ… ç¼–æ ¡å®Œæˆï¼Œå…±å‘ç° ' + allIssues.length + ' å¤„é—®é¢˜', 'ok');
      renderResults();
      return;
    }
    pt.textContent = 'ç¼–æ ¡ä¸­... æ‰¹æ¬¡ ' + (idx + 1) + '/' + batches.length;
    pf.style.width = ((idx + 1) / batches.length * 100) + '%';

    fetch(getApiBase() + '/api/proofread', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ paragraphs: batches[idx] })
    })
    .then(function(r) { return r.json(); })
    .then(function(data) {
      if (data.issues) {
        data.issues.forEach(function(iss) {
          var gIdx = allIssues.length;
          issueStates[gIdx] = 'pending';
          allIssues.push(iss);
        });
      }
      nextBatch(idx + 1);
    })
    .catch(function(err) {
      showStatus('âŒ ç¼–æ ¡å¤±è´¥: ' + err.message, 'err');
      btn.disabled = false;
      btn.textContent = 'å¼€å§‹ç¼–æ ¡';
    });
  }

  nextBatch(0);
}

function renderResults() {
  var rc = document.getElementById('resultCard');
  rc.style.display = 'block';

  var counts = { error: 0, warning: 0, info: 0 };
  allIssues.forEach(function(iss) {
    var s = iss.severity || 'info';
    counts[s] = (counts[s] || 0) + 1;
  });

  var sb = document.getElementById('statsBar');
  sb.innerHTML =
    '<span class="stat-badge stat-error' + (currentFilter === 'error' ? ' active' : '') + '" onclick="filterBy(\'error\')">ğŸ”´ é”™è¯¯ ' + counts.error + '</span>' +
    '<span class="stat-badge stat-warning' + (currentFilter === 'warning' ? ' active' : '') + '" onclick="filterBy(\'warning\')">ğŸŸ¡ å­˜ç–‘ ' + counts.warning + '</span>' +
    '<span class="stat-badge stat-info' + (currentFilter === 'info' ? ' active' : '') + '" onclick="filterBy(\'info\')">ğŸ”µ å»ºè®® ' + counts.info + '</span>' +
    '<span class="stat-badge' + (currentFilter === 'all' ? ' active' : '') + '" onclick="filterBy(\'all\')">å…¨éƒ¨ ' + allIssues.length + '</span>';

  document.getElementById('batchActions').style.display = allIssues.length > 0 ? 'flex' : 'none';

  updateSummary();
  renderIssueList();
}

function updateSummary() {
  var accepted = 0, ignored = 0, pending = 0;
  for (var k in issueStates) {
    if (issueStates[k] === 'accepted') accepted++;
    else if (issueStates[k] === 'ignored') ignored++;
    else pending++;
  }
  var bar = document.getElementById('summaryBar');
  if (accepted > 0 || ignored > 0) {
    bar.style.display = 'flex';
    bar.innerHTML =
      '<span>âœ… å·²ä¿®å¤ ' + accepted + '</span>' +
      '<span>âŠ˜ å·²å¿½ç•¥ ' + ignored + '</span>' +
      '<span>â³ å¾…å¤„ç† ' + pending + '</span>';
  } else {
    bar.style.display = 'none';
  }
}

function renderIssueList() {
  var list = document.getElementById('issueList');
  var catLabels = {
    spelling: 'é”™åˆ«å­—', grammar: 'è¯­ç—…', punctuation: 'æ ‡ç‚¹',
    terminology: 'æœ¯è¯­', consistency: 'ä¸€è‡´æ€§', expression: 'è¡¨è¾¾'
  };
  var catClass = {
    spelling: 'cat-spelling', grammar: 'cat-grammar', punctuation: 'cat-punctuation',
    terminology: 'cat-terminology', consistency: 'cat-consistency', expression: 'cat-expression'
  };

  var html = '';
  allIssues.forEach(function(iss, idx) {
    if (currentFilter !== 'all' && iss.severity !== currentFilter) return;

    var state = issueStates[idx] || 'pending';
    var resolved = state !== 'pending';
    var sevClass = 'sev-' + (iss.severity || 'info');

    html += '<div class="issue-item' + (resolved ? ' resolved' : '') + '" id="issue-' + idx + '">';
    html += '<div class="issue-header">';
    html += '<div><span class="issue-cat ' + (catClass[iss.category] || 'cat-expression') + '">' + (catLabels[iss.category] || iss.category) + '</span></div>';
    html += '<span class="issue-para">Â¶' + (iss.paragraph_index + 1) + '</span>';
    html += '</div>';

    html += '<div class="issue-content">';
    html += '<span class="issue-sev ' + sevClass + '"></span>';
    html += '<span class="issue-original">' + esc(iss.original) + '</span>';
    html += '<span class="issue-arrow">â†’</span>';
    html += '<span class="issue-suggestion">' + esc(iss.suggestion) + '</span>';
    html += '</div>';

    html += '<div class="issue-reason">' + esc(iss.reason) + '</div>';

    if (state === 'accepted') {
      html += '<span class="issue-status status-accepted">âœ… å·²ä¿®å¤</span>';
    } else if (state === 'ignored') {
      html += '<span class="issue-status status-ignored">âŠ˜ å·²å¿½ç•¥</span>';
      html += ' <button class="btn btn-sm btn-ghost" style="margin-top:4px" onclick="undoIssue(' + idx + ')">â†© æ’¤é”€</button>';
    } else {
      html += '<div class="issue-actions">';
      html += '<button class="btn btn-sm btn-success" onclick="acceptIssue(' + idx + ')">âœ… é‡‡çº³</button>';
      html += '<button class="btn btn-sm btn-danger" onclick="ignoreIssue(' + idx + ')">âŠ˜ å¿½ç•¥</button>';
      html += '<button class="btn btn-sm btn-ghost" onclick="locateIssue(' + idx + ')">ğŸ“ å®šä½</button>';
      html += '</div>';
    }

    html += '</div>';
  });

  list.innerHTML = html || '<div style="text-align:center;color:var(--muted);padding:20px">ğŸ‰ æ²¡æœ‰å‘ç°é—®é¢˜</div>';
}

function filterBy(type) {
  currentFilter = type;
  renderResults();
}

function acceptIssue(idx) {
  var iss = allIssues[idx];
  if (!iss || !iss.original || !iss.suggestion) {
    showStatus('âŒ è¯¥é—®é¢˜ç¼ºå°‘æ›¿æ¢ä¿¡æ¯', 'err');
    return;
  }

  Word.run(function(ctx) {
    // å…¨æ–‡æœç´¢ï¼Œä¸ä¾èµ– paragraph_indexï¼ˆé¿å…ç´¢å¼•åç§»é—®é¢˜ï¼‰
    var searchResults = ctx.document.body.search(iss.original, { matchCase: false, matchWholeWord: false });
    searchResults.load('text');
    return ctx.sync().then(function() {
      if (searchResults.items.length > 0) {
        searchResults.items[0].insertText(iss.suggestion, 'Replace');
        return ctx.sync().then(function() {
          issueStates[idx] = 'accepted';
          renderResults();
          showStatus('âœ… å·²æ›¿æ¢: ' + iss.original + ' â†’ ' + iss.suggestion, 'ok');
        });
      } else {
        showStatus('âš ï¸ æœªæ‰¾åˆ°åŸæ–‡"' + iss.original + '"ï¼Œå¯èƒ½å·²è¢«ä¿®æ”¹', 'err');
      }
    });
  }).catch(function(err) {
    showStatus('âŒ æ›¿æ¢å¤±è´¥: ' + err.message, 'err');
  });
}

function ignoreIssue(idx) {
  issueStates[idx] = 'ignored';
  renderResults();
}

function undoIssue(idx) {
  issueStates[idx] = 'pending';
  renderResults();
}

function locateIssue(idx) {
  var iss = allIssues[idx];
  Word.run(function(ctx) {
    if (iss.original) {
      var searchResults = ctx.document.body.search(iss.original, { matchCase: false });
      searchResults.load('text');
      return ctx.sync().then(function() {
        if (searchResults.items.length > 0) {
          searchResults.items[0].select();
        }
        return ctx.sync();
      });
    } else {
      var paragraphs = ctx.document.body.paragraphs;
      paragraphs.load('text');
      return ctx.sync().then(function() {
        var pIdx = iss.paragraph_index;
        if (pIdx >= 0 && pIdx < paragraphs.items.length) {
          paragraphs.items[pIdx].select();
          return ctx.sync();
        }
      });
    }
  }).catch(function(err) {
    showStatus('âŒ å®šä½å¤±è´¥: ' + err.message, 'err');
  });
}

function batchAcceptAll() {
  var toAccept = [];
  allIssues.forEach(function(iss, idx) {
    if (issueStates[idx] !== 'pending') return;
    if (iss.original && iss.suggestion) toAccept.push(idx);
  });

  if (toAccept.length === 0) {
    showStatus('æ²¡æœ‰å¯é‡‡çº³çš„é—®é¢˜', 'ok');
    return;
  }

  if (!confirm('ç¡®è®¤å…¨éƒ¨é‡‡çº³ï¼ˆå…± ' + toAccept.length + ' å¤„ï¼‰ï¼Ÿå°†ç›´æ¥ä¿®æ”¹æ–‡æ¡£å†…å®¹ã€‚')) return;

  showStatus('æ­£åœ¨æ‰¹é‡æ›¿æ¢...', 'loading');

  Word.run(function(ctx) {
    var searchPairs = [];
    toAccept.forEach(function(idx) {
      var iss = allIssues[idx];
      var sr = ctx.document.body.search(iss.original, { matchCase: false, matchWholeWord: false });
      sr.load('text');
      searchPairs.push({ idx: idx, sr: sr, iss: iss });
    });
    return ctx.sync().then(function() {
      var replaced = 0;
      searchPairs.forEach(function(p) {
        if (p.sr.items.length > 0) {
          p.sr.items[0].insertText(p.iss.suggestion, 'Replace');
          issueStates[p.idx] = 'accepted';
          replaced++;
        }
      });
      return ctx.sync().then(function() {
        renderResults();
        showStatus('âœ… å·²æ›¿æ¢ ' + replaced + ' å¤„', 'ok');
      });
    });
  }).catch(function(err) {
    showStatus('âŒ æ‰¹é‡æ›¿æ¢å¤±è´¥: ' + err.message, 'err');
  });
}

function batchIgnoreAll() {
  var toIgnore = 0;
  allIssues.forEach(function(iss, idx) {
    if (issueStates[idx] === 'pending') {
      issueStates[idx] = 'ignored';
      toIgnore++;
    }
  });
  renderResults();
  showStatus('å·²å¿½ç•¥ ' + toIgnore + ' å¤„é—®é¢˜', 'ok');
}

function clearResults() {
  showStatus('æ­£åœ¨æ¸…é™¤æ–‡æ¡£ä¸­çš„æŠ¥å‘Š...', 'loading');
  Word.run(function(ctx) {
    // æœç´¢æŠ¥å‘Šåˆ†éš”çº¿
    var sepResults = ctx.document.body.search('â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”', { matchCase: true });
    sepResults.load('text');
    return ctx.sync().then(function() {
      if (sepResults.items.length === 0) {
        showStatus('æ–‡æ¡£ä¸­æ²¡æœ‰æ‰¾åˆ°ç¼–æ ¡æŠ¥å‘Š', 'ok');
        return;
      }
      // å–æœ€åä¸€ä¸ªåˆ†éš”çº¿ï¼ˆæœ€è¿‘ä¸€æ¬¡å¯¼å‡ºçš„æŠ¥å‘Šï¼‰
      var sepRange = sepResults.items[sepResults.items.length - 1];
      var endRange = ctx.document.body.getRange('End');
      var reportRange = sepRange.expandTo(endRange);
      reportRange.delete();
      return ctx.sync().then(function() {
        showStatus('âœ… å·²æ¸…é™¤æ–‡æ¡£ä¸­çš„ç¼–æ ¡æŠ¥å‘Š', 'ok');
      });
    });
  }).catch(function(err) {
    showStatus('âŒ æ¸…é™¤å¤±è´¥: ' + err.message, 'err');
  });
}

function writeComments() {
  var pending = [];
  allIssues.forEach(function(iss, idx) {
    if (issueStates[idx] === 'accepted') return;
    if (iss.original) pending.push(iss);
  });

  if (pending.length === 0) {
    showStatus('æ²¡æœ‰éœ€è¦å†™å…¥æ‰¹æ³¨çš„é—®é¢˜', 'ok');
    return;
  }

  showStatus('æ­£åœ¨å†™å…¥æ‰¹æ³¨...', 'loading');

  Word.run(function(ctx) {
    var searchPairs = [];
    pending.forEach(function(iss) {
      var sr = ctx.document.body.search(iss.original, { matchCase: false });
      sr.load('text');
      searchPairs.push({ sr: sr, iss: iss });
    });
    return ctx.sync().then(function() {
      var written = 0;
      searchPairs.forEach(function(p) {
        if (p.sr.items.length > 0) {
          var range = p.sr.items[0];
          // å…ˆå°è¯• insertCommentï¼ˆOffice 2021+ï¼‰ï¼Œå¤±è´¥åˆ™ç”¨é«˜äº®+å°¾æ³¨æ–¹å¼
          try {
            var sevLabel = { error: '\u{1F534}', warning: '\u{1F7E1}', info: '\u{1F535}' };
            var comment = (sevLabel[p.iss.severity] || '') + ' ' + (p.iss.suggestion || '') + ' | ' + (p.iss.reason || '');
            range.insertComment(comment);
            written++;
          } catch(e) {
            // Fallback: é«˜äº®åŸæ–‡ + åœ¨åé¢æ’å…¥æ‰¹æ³¨æ–‡æœ¬
            range.font.highlightColor = p.iss.severity === 'error' ? 'Red' : (p.iss.severity === 'warning' ? 'Yellow' : 'Turquoise');
            var note = ' [' + (p.iss.suggestion || '') + ']';
            var inserted = range.insertText(note, 'After');
            inserted.font.color = '#c00000';
            inserted.font.size = 8;
            inserted.font.italic = true;
            written++;
          }
        }
      });
      return ctx.sync().then(function() {
        showStatus('\u2705 å·²å†™å…¥ ' + written + ' æ¡æ‰¹æ³¨', 'ok');
      });
    });
  }).catch(function(err) {
    showStatus('\u274C æ‰¹æ³¨å†™å…¥å¤±è´¥: ' + err.message, 'err');
  });
}

function exportReport() {
  if (allIssues.length === 0) return;

  var sevLabels = { error: '\u{1F534} é”™è¯¯', warning: '\u{1F7E1} å­˜ç–‘', info: '\u{1F535} å»ºè®®' };
  var catLabels = {
    spelling: 'é”™åˆ«å­—', grammar: 'è¯­ç—…', punctuation: 'æ ‡ç‚¹',
    terminology: 'æœ¯è¯­', consistency: 'ä¸€è‡´æ€§', expression: 'è¡¨è¾¾'
  };
  var stateLabels = { accepted: '\u2705å·²ä¿®å¤', ignored: '\u2298å·²å¿½ç•¥', pending: '\u23F3å¾…å¤„ç†' };

  var accepted = 0, ignored = 0, pendingCount = 0;
  for (var k in issueStates) {
    if (issueStates[k] === 'accepted') accepted++;
    else if (issueStates[k] === 'ignored') ignored++;
    else pendingCount++;
  }

  Word.run(function(ctx) {
    var body = ctx.document.body;
    // åˆ†éš”çº¿
    var sep = body.insertParagraph('â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”', 'End');
    sep.font.color = '#c8c6c4';
    // æ ‡é¢˜
    var title = body.insertParagraph('æ™ºç¼–ç¼–è¾‘åŠ©æ‰‹ â€” ç¼–æ ¡æŠ¥å‘Š', 'End');
    title.font.bold = true;
    title.font.size = 12;
    title.font.color = '#0078d4';
    // ç»Ÿè®¡
    var stats = body.insertParagraph('å·²ä¿®å¤: ' + accepted + '  |  å·²å¿½ç•¥: ' + ignored + '  |  å¾…å¤„ç†: ' + pendingCount, 'End');
    stats.font.size = 10;
    body.insertParagraph('', 'End');
    // é€æ¡
    allIssues.forEach(function(iss, idx) {
      var state = issueStates[idx] || 'pending';
      var line1 = (idx + 1) + '. ' + (sevLabels[iss.severity] || '') + ' [' + (catLabels[iss.category] || iss.category) + '] â€” ' + stateLabels[state];
      var p1 = body.insertParagraph(line1, 'End');
      p1.font.bold = true;
      p1.font.size = 10;

      if (iss.original) {
        body.insertParagraph('   åŸæ–‡ï¼š' + iss.original, 'End');
      }
      if (iss.suggestion) {
        body.insertParagraph('   å»ºè®®ï¼š' + iss.suggestion, 'End');
      }
      if (iss.reason) {
        var rp = body.insertParagraph('   ' + iss.reason, 'End');
        rp.font.color = '#605e5c';
        rp.font.size = 10;
      }
    });

    return ctx.sync().then(function() {
      showStatus('\u2705 æŠ¥å‘Šå·²æ’å…¥æ–‡æ¡£æœ«å°¾', 'ok');
    });
  }).catch(function(err) {
    showStatus('\u274C å¯¼å‡ºå¤±è´¥: ' + err.message, 'err');
  });
}

function esc(s) {
  var d = document.createElement('div');
  d.textContent = s || '';
  return d.innerHTML;
}

// ========== å‚è€ƒæ–‡çŒ®æ ¸æŸ¥ ==========

function startRefCheck() {
  var verifyDoi = document.getElementById('chkVerifyDoi').checked;
  document.getElementById('refProgressText').textContent = 'æ­£åœ¨è¯»å–æ–‡æ¡£...';
  document.getElementById('refResultCard').style.display = 'none';

  Word.run(function(ctx) {
    var paragraphs = ctx.document.body.paragraphs;
    paragraphs.load('text');
    return ctx.sync().then(function() {
      // å…ˆæ‹¼æˆå®Œæ•´æ–‡æœ¬ï¼Œå†åœ¨æ¯ä¸ª [æ•°å­—] å‰æ’æ¢è¡Œï¼Œæœ€åæŒ‰è¡Œåˆ‡åˆ†
      var rawLines = [];
      for (var i = 0; i < paragraphs.items.length; i++) {
        rawLines.push(paragraphs.items[i].text);
      }
      var fullText = rawLines.join('\n');
      // åœ¨æ¯ä¸ª [æ•°å­—] å‰æ’æ¢è¡Œï¼ˆåªåŒ¹é…çº¯æ•°å­—åºå·ï¼Œä¸å½±å“ [J][M] ç­‰ï¼‰
      fullText = fullText.replace(/(?=\[\d+\])/g, '\n');
      var lines = fullText.split('\n');

      // æ‰¾å‚è€ƒæ–‡çŒ®èµ·å§‹è¡Œ
      var refsText = '';
      var refStartIdx = -1;
      for (var j = 0; j < lines.length; j++) {
        var trimmed = lines[j].trim();
        if (/^å‚è€ƒæ–‡çŒ®\s*$/.test(trimmed) || /^References\s*$/i.test(trimmed)) {
          refStartIdx = j;
          break;
        }
      }
      if (refStartIdx < 0) {
        for (var k = 0; k < lines.length; k++) {
          if (/^\s*\[1\]/.test(lines[k])) {
            refStartIdx = k;
            break;
          }
        }
      }
      if (refStartIdx >= 0) {
        refsText = lines.slice(refStartIdx).join('\n');
      }

      if (!refsText || refsText.trim().length < 5) {
        // æ˜¾ç¤ºæ–‡æ¡£æœ€å20è¡Œï¼Œå¸®åŠ©è°ƒè¯•
        var lastLines = lines.filter(function(l){ return l.trim(); }).slice(-20);
        document.getElementById('refProgressText').textContent =
          'æœªæ‰¾åˆ°å‚è€ƒæ–‡çŒ®ã€‚æœ«å°¾20è¡Œï¼š\n' + lastLines.join('\n');
        return;
      }

      var refCount = refsText.split('\n').filter(function(l){ return /^\s*\[\d+\]/.test(l); }).length;
      document.getElementById('refProgressText').textContent =
        'è¯†åˆ«åˆ° ' + refCount + ' æ¡æ–‡çŒ®ï¼Œæ­£åœ¨æ ¸æŸ¥' + (verifyDoi ? 'ï¼ˆå«DOIéªŒè¯ï¼Œè¾ƒæ…¢ï¼‰' : '') + '...';

      return fetch(getApiBase() + '/api/check-refs', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          refs_text: refsText,
          body_text: '',
          verify_dois: verifyDoi,
        })
      })
      .then(function(r) { return r.json(); })
      .then(function(data) {
        document.getElementById('refProgressText').textContent = '';
        renderRefResults(data);
      })
      .catch(function(err) {
        document.getElementById('refProgressText').textContent = 'æ ¸æŸ¥å¤±è´¥: ' + err.message;
      });
    });
  }).catch(function(err) {
    document.getElementById('refProgressText').textContent = 'è¯»å–æ–‡æ¡£å¤±è´¥: ' + err.message;
  });
}

function renderRefResults(data) {
  var card = document.getElementById('refResultCard');
  var summary = document.getElementById('refSummaryBar');
  var list = document.getElementById('refIssueList');

  card.style.display = 'block';
  summary.textContent = data.summary;

  if (!data.issues || data.issues.length === 0) {
    list.innerHTML = '<div style="color:var(--success); padding:8px">âœ… æœªå‘ç°é—®é¢˜</div>';
    return;
  }

  var sevIcon = { error: 'ğŸ”´', warning: 'ğŸŸ¡', info: 'ğŸ”µ' };
  var catLabel = { format: 'æ ¼å¼', doi: 'DOI', metadata: 'å…ƒæ•°æ®', citation: 'å¼•ç”¨' };
  var html = '';
  data.issues.forEach(function(iss) {
    html += '<div class="issue-item" style="margin-bottom:8px; padding:8px; border-left:3px solid ' +
      (iss.severity === 'error' ? '#d13438' : iss.severity === 'warning' ? '#f7630c' : '#0078d4') + '">';
    html += '<div style="font-size:11px; font-weight:600">' +
      (sevIcon[iss.severity] || '') + ' [' + iss.ref_index + '] ' +
      (catLabel[iss.category] || iss.category) + '</div>';
    html += '<div style="font-size:11px; margin-top:3px">' + iss.message + '</div>';
    if (iss.suggestion) {
      html += '<div style="font-size:10px; color:var(--muted); margin-top:2px">ğŸ’¡ ' + iss.suggestion + '</div>';
    }
    if (iss.raw) {
      html += '<div style="font-size:10px; color:var(--muted); margin-top:2px; font-style:italic">' +
        iss.raw.substring(0, 80) + (iss.raw.length > 80 ? '...' : '') + '</div>';
    }
    html += '</div>';
  });
  list.innerHTML = html;
}

// ========== çŸ¥è¯†åº“ç®¡ç† ==========

function loadKnowledge() {
  fetch(getApiBase() + '/api/knowledge')
    .then(function(r) { return r.json(); })
    .then(function(data) {
      var status = document.getElementById('kbStatus');
      var list = document.getElementById('kbSources');
      if (data.total_chunks === 0) {
        status.textContent = 'çŸ¥è¯†åº“ä¸ºç©ºï¼Œä¸Šä¼ è§„èŒƒæ–‡æ¡£å¯æå‡ç¼–æ ¡å‡†ç¡®ç‡';
        list.innerHTML = '';
        return;
      }
      status.textContent = 'å…± ' + data.total_chunks + ' ä¸ªçŸ¥è¯†ç‰‡æ®µ';
      var html = '';
      data.sources.forEach(function(s) {
        html += '<div style="display:flex; justify-content:space-between; align-items:center; padding:3px 0; border-bottom:1px solid var(--border)">';
        html += '<span>ğŸ“„ ' + s.source + ' (' + s.chunks + 'æ®µ)</span>';
        html += '<button class="btn btn-sm btn-danger" style="padding:1px 6px; font-size:10px" onclick="deleteKnowledge(\'' + s.source.replace(/'/g, "\\'") + '\')">åˆ é™¤</button>';
        html += '</div>';
      });
      list.innerHTML = html;
    })
    .catch(function() {
      document.getElementById('kbStatus').textContent = 'çŸ¥è¯†åº“åŠ è½½å¤±è´¥';
    });
}

function uploadKnowledge() {
  var fileInput = document.getElementById('kbFile');
  if (!fileInput.files || !fileInput.files[0]) {
    showStatus('è¯·å…ˆé€‰æ‹©æ–‡ä»¶', 'err');
    return;
  }
  var file = fileInput.files[0];
  var formData = new FormData();
  formData.append('file', file);

  showStatus('æ­£åœ¨ä¸Šä¼  ' + file.name + '...', 'loading');
  fetch(getApiBase() + '/api/knowledge/upload', { method: 'POST', body: formData })
    .then(function(r) {
      if (!r.ok) return r.json().then(function(d) { throw new Error(d.detail || 'ä¸Šä¼ å¤±è´¥'); });
      return r.json();
    })
    .then(function(data) {
      showStatus('âœ… å·²å¯¼å…¥ ' + data.chunks + ' ä¸ªçŸ¥è¯†ç‰‡æ®µ', 'ok');
      fileInput.value = '';
      loadKnowledge();
    })
    .catch(function(err) {
      showStatus('âŒ ' + err.message, 'err');
    });
}

function deleteKnowledge(source) {
  if (!confirm('ç¡®å®šåˆ é™¤ã€Œ' + source + 'ã€ï¼Ÿ')) return;
  fetch(getApiBase() + '/api/knowledge/' + encodeURIComponent(source), { method: 'DELETE' })
    .then(function(r) { return r.json(); })
    .then(function(data) {
      showStatus('å·²åˆ é™¤ ' + data.deleted + ' ä¸ªç‰‡æ®µ', 'ok');
      loadKnowledge();
    })
    .catch(function() { showStatus('åˆ é™¤å¤±è´¥', 'err'); });
}

// é¡µé¢åŠ è½½æ—¶åˆ·æ–°çŸ¥è¯†åº“çŠ¶æ€
try { loadKnowledge(); } catch(e) {}

</script>
</body>
</html>
